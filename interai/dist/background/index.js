var I=Object.defineProperty;var A=(a,e,s)=>e in a?I(a,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):a[e]=s;var o=(a,e,s)=>A(a,typeof e!="symbol"?e+"":e,s);import{D as P}from"../assets/DataManager-BWgrTf4M.js";class S{constructor(){o(this,"sensitivity",.7);o(this,"enableTextAnalysis",!0);o(this,"enableAudioAnalysis",!1);o(this,"onQuestionCallback",null);o(this,"recentTranscripts",[]);o(this,"maxContextLength",5);o(this,"questionWords",["what","when","where","who","why","how","which","whose","whom","can","could","would","should","may","might","do","does","did","is","are","was","were","have","has","had"]);o(this,"questionPhrases",["tell me about","describe","explain","walk me through","give me an example","can you","could you","what is","what are","how do","how did","why did","why do"])}processTranscript(e,s){if(e.trim()&&(this.recentTranscripts.push(e),this.recentTranscripts.length>this.maxContextLength&&this.recentTranscripts.shift(),this.enableTextAnalysis&&this.detectQuestionFromText(e))){const r=[...this.recentTranscripts.slice(0,-1)],i=e.trim();this.onQuestionCallback&&this.onQuestionCallback(i,r)}}detectQuestionFromText(e){const s=e.toLowerCase().trim();return!!(e.includes("?")||this.questionWords.some(i=>s.startsWith(i+" ")||s.startsWith(i+"?"))||this.questionPhrases.some(i=>s.includes(i))&&e.length>=10)}onQuestionDetected(e){this.onQuestionCallback=e}setSensitivity(e){this.sensitivity=Math.max(0,Math.min(1,e))}setEnableTextAnalysis(e){this.enableTextAnalysis=e}setEnableAudioAnalysis(e){this.enableAudioAnalysis=e}clearContext(){this.recentTranscripts=[]}}class T{constructor(e,s,t){o(this,"apiKey","");o(this,"provider","openai");o(this,"model","gpt-3.5-turbo");o(this,"baseURL","https://api.openai.com/v1");o(this,"maxTokens",500);o(this,"temperature",.7);e&&(this.apiKey=e),s&&(this.provider=s),t&&(this.model=t),this.provider==="openai"?this.baseURL="https://api.openai.com/v1":this.provider==="anthropic"?this.baseURL="https://api.anthropic.com/v1":this.provider==="openrouter"&&(this.baseURL="https://openrouter.ai/api/v1")}async generateSuggestion(e,s,t){if(!this.apiKey)throw new Error("API key not configured");const r=this.buildPrompt(e,s,t);try{const i=await this.callAPI(r),n=this.parseResponse(i);return{id:crypto.randomUUID(),questionId:"",generatedAt:new Date,model:this.model,answer:n.fullAnswer,keyPoints:n.keyPoints,structure:n.structure,wasShown:!1,wasEdited:!1}}catch(i){throw console.error("LLM API error:",i),i}}async streamSuggestion(e,s,t,r){if(!this.apiKey)throw new Error("API key not configured");const i=this.buildPrompt(e,s,t);let n="";try{return await this.callStreamingAPI(i,c=>{n+=c,r(c)}),n}catch(c){throw console.error("LLM streaming error:",c),c}}buildPrompt(e,s,t){const r=this.formatResume(s),i=this.formatJobDescription(t);return`You are an interview coach helping a candidate prepare answers. Based on the candidate's resume and the job description, provide a structured, concise answer to the interview question.

CANDIDATE RESUME:
${r}

JOB DESCRIPTION:
${i}

INTERVIEW QUESTION:
${e}

Provide a well-structured answer that:
1. Is relevant to the candidate's experience
2. Aligns with the job requirements
3. Uses the STAR method (Situation, Task, Action, Result) when appropriate
4. Is concise (2-3 minutes when spoken)
5. Highlights relevant skills and achievements

Format your response as:
- A clear, conversational answer (2-3 paragraphs)
- Key talking points (3-5 bullet points)
- Structure: STAR method if applicable, otherwise freeform

Answer:`}formatResume(e){let s=`Name: ${e.personalInfo.fullName}
`;return e.personalInfo.summary&&(s+=`Summary: ${e.personalInfo.summary}
`),s+=`
Work Experience:
`,e.workExperience.forEach(t=>{const r=this.parseDate(t.startDate),i=t.endDate?this.parseDate(t.endDate):null,n=r.getFullYear(),c=i?i.getFullYear():"Present";s+=`- ${t.position} at ${t.company} (${n}-${c})
`,s+=`  ${t.description}
`,t.achievements.length>0&&(s+=`  Key achievements: ${t.achievements.join(", ")}
`)}),s+=`
Skills: ${e.skills.technical.join(", ")}
`,s}parseDate(e){if(!e)return new Date;if(e instanceof Date)return e;if(typeof e=="string"){const s=new Date(e);return isNaN(s.getTime())?new Date:s}return new Date}formatJobDescription(e){let s=`Position: ${e.title} at ${e.company}
`;return s+=`Description: ${e.description}
`,e.responsibilities.length>0&&(s+=`Responsibilities: ${e.responsibilities.join(", ")}
`),e.requirements.length>0&&(s+=`Requirements: ${e.requirements.join(", ")}
`),s}async callAPI(e){var r;const s={"Content-Type":"application/json",Authorization:`Bearer ${this.apiKey}`};if(this.provider==="openrouter"){const i=typeof window<"u"&&window.location?window.location.origin:"https://interviewcopilot.com";s["HTTP-Referer"]=i,s["X-Title"]="InterviewCopilot"}const t=await fetch(`${this.baseURL}/chat/completions`,{method:"POST",headers:s,body:JSON.stringify({model:this.model,messages:[{role:"system",content:"You are a helpful interview coach that provides structured, relevant answers to interview questions."},{role:"user",content:e}],max_tokens:this.maxTokens,temperature:this.temperature})});if(!t.ok){const n=((r=(await t.json()).error)==null?void 0:r.message)||t.statusText;throw n.includes("quota")||n.includes("exceeded")||n.includes("plan limit")?new Error(`OpenAI API quota exceeded. Important: ChatGPT Plus/Premium subscription is separate from API access. To use this extension, you need to:

1. Go to https://platform.openai.com/api-keys
2. Add a payment method to your OpenAI API account
3. Set up usage limits (pay-as-you-go)

Your ChatGPT Plus subscription gives you access to chat.openai.com, but API access requires separate billing setup. Visit https://platform.openai.com/account/billing to set up API billing.`):n.includes("invalid_api_key")||n.includes("authentication")?new Error("Invalid API key. Please check your API key in the extension settings. Make sure you're using a valid OpenAI API key."):n.includes("rate_limit")?new Error("Rate limit exceeded. Please wait a moment and try again. Too many requests were sent in a short period."):new Error(`API error: ${n}`)}return t.json()}async callStreamingAPI(e,s){var c,h,p,d;const t={"Content-Type":"application/json",Authorization:`Bearer ${this.apiKey}`};if(this.provider==="openrouter"){const m=typeof window<"u"&&window.location?window.location.origin:"https://interviewcopilot.com";t["HTTP-Referer"]=m,t["X-Title"]="InterviewCopilot"}const r=await fetch(`${this.baseURL}/chat/completions`,{method:"POST",headers:t,body:JSON.stringify({model:this.model,messages:[{role:"system",content:"You are a helpful interview coach that provides structured, relevant answers to interview questions."},{role:"user",content:e}],max_tokens:this.maxTokens,temperature:this.temperature,stream:!0})});if(!r.ok){const u=((c=(await r.json()).error)==null?void 0:c.message)||r.statusText;throw u.includes("quota")||u.includes("exceeded")||u.includes("plan limit")?new Error(`OpenAI API quota exceeded. Important: ChatGPT Plus/Premium subscription is separate from API access. To use this extension, you need to:

1. Go to https://platform.openai.com/api-keys
2. Add a payment method to your OpenAI API account
3. Set up usage limits (pay-as-you-go)

Your ChatGPT Plus subscription gives you access to chat.openai.com, but API access requires separate billing setup. Visit https://platform.openai.com/account/billing to set up API billing.`):u.includes("invalid_api_key")||u.includes("authentication")?new Error("Invalid API key. Please check your API key in the extension settings. Make sure you're using a valid OpenAI API key."):u.includes("rate_limit")?new Error("Rate limit exceeded. Please wait a moment and try again. Too many requests were sent in a short period."):new Error(`API error: ${u}`)}const i=(h=r.body)==null?void 0:h.getReader(),n=new TextDecoder;if(!i)throw new Error("No response body");for(;;){const{done:m,value:u}=await i.read();if(m)break;const g=n.decode(u).split(`
`).filter(w=>w.trim()!=="");for(const w of g)if(w.startsWith("data: ")){const y=w.slice(6);if(y==="[DONE]")return;try{const f=((d=(p=JSON.parse(y).choices[0])==null?void 0:p.delta)==null?void 0:d.content)||"";f&&s(f)}catch{}}}}parseResponse(e){var c,h;const s=((h=(c=e.choices[0])==null?void 0:c.message)==null?void 0:h.content)||"",t=[],r=s.split(`
`);for(const p of r){const d=p.trim();d.match(/^[-*]\s+/)&&t.push(d.replace(/^[-*]\s+/,""))}let i="freeform";const n=s.toLowerCase();return n.includes("situation")&&n.includes("task")&&n.includes("action")&&n.includes("result")&&(i="STAR"),{fullAnswer:s,keyPoints:t.length>0?t:[s.substring(0,100)+"..."],structure:i}}setAPIKey(e){this.apiKey=e}setProvider(e){this.provider=e,e==="openai"?this.baseURL="https://api.openai.com/v1":e==="anthropic"?this.baseURL="https://api.anthropic.com/v1":e==="openrouter"&&(this.baseURL="https://openrouter.ai/api/v1")}setModel(e){this.model=e}setMaxTokens(e){this.maxTokens=e}setTemperature(e){this.temperature=e}}class b{constructor(){o(this,"questionDetector");o(this,"llmIntegration",null);o(this,"dataManager");o(this,"currentSession",null);o(this,"isActive",!1);this.questionDetector=new S,this.dataManager=new P,this.setupEventHandlers()}setupEventHandlers(){this.questionDetector.onQuestionDetected(async(e,s)=>{if(!this.currentSession)return;const t={id:crypto.randomUUID(),timestamp:new Date,questionText:e,detectedMethod:"punctuation",confidence:.8,context:s};if(this.currentSession.questions.push(t),this.sendToContentScript({type:"question_detected",data:t}),this.llmIntegration)try{const r=await this.dataManager.getResume(),i=await this.dataManager.getJobDescription(this.currentSession.jobDescriptionId);if(r&&i){const n=await this.llmIntegration.generateSuggestion(e,r,i);t.suggestion=n,n.questionId=t.id,this.sendToContentScript({type:"suggestion_ready",data:{questionId:t.id,questionEntry:t,suggestion:n}})}}catch(r){console.error("Failed to generate suggestion:",r),this.sendToContentScript({type:"suggestion_error",data:{questionId:t.id,error:String(r)}})}})}async startSession(e,s){if(this.isActive)throw new Error("Session already active");const t=await this.dataManager.getSettings();if(!t)throw new Error("Settings not configured");t.apiKey&&(this.llmIntegration=new T(t.apiKey,t.llmProvider,t.llmModel),this.llmIntegration.setMaxTokens(t.maxTokens),this.llmIntegration.setTemperature(t.temperature)),this.currentSession={id:crypto.randomUUID(),createdAt:new Date,jobDescriptionId:e,resumeId:s,platform:"other",status:"active",transcript:[],questions:[],settings:{llmProvider:t.llmProvider,llmModel:t.llmModel,sttProvider:t.sttProvider,questionSensitivity:t.questionSensitivity}},this.isActive=!0,this.sendToContentScript({type:"start_audio_capture",data:{sessionId:this.currentSession.id}})}async stopSession(){this.isActive&&(this.sendToContentScript({type:"stop_audio_capture",data:{}}),this.currentSession&&(this.currentSession.endedAt=new Date,this.currentSession.duration=(this.currentSession.endedAt.getTime()-this.currentSession.createdAt.getTime())/1e3,this.currentSession.status="completed",await this.dataManager.saveSession(this.currentSession)),this.isActive=!1,this.currentSession=null,this.llmIntegration=null,this.sendToContentScript({type:"session_ended",data:{}}))}sendToContentScript(e){chrome.tabs.query({active:!0,currentWindow:!0},s=>{var t;(t=s[0])!=null&&t.id&&chrome.tabs.sendMessage(s[0].id,e).catch(()=>{})})}isSessionActive(){return this.isActive}}const l=new b;chrome.runtime.onMessage.addListener((a,e,s)=>((async()=>{try{switch(a.type){case"start_session":await l.startSession(a.data.jobDescriptionId,a.data.resumeId),s({success:!0});break;case"stop_session":await l.stopSession(),s({success:!0});break;case"get_session_status":s({active:l.isSessionActive()});break;case"transcript":if(l.currentSession){const t=a.data;l.currentSession.transcript.push(t),l.questionDetector.processTranscript(t.text)}s({received:!0});break;default:s({error:"Unknown message type"})}}catch(t){console.error("Background error:",t),s({error:String(t)})}})(),!0));chrome.runtime.onInstalled.addListener(()=>{console.log("InterviewCopilot installed")});
